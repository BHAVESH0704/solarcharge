{
  "entities": {
    "ChargingStation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ChargingStation",
      "type": "object",
      "description": "Represents a charging station with its location, status, and energy consumption details.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the charging station."
        },
        "name": {
          "type": "string",
          "description": "Name of the charging station."
        },
        "latitude": {
          "type": "number",
          "description": "Latitude coordinate of the charging station."
        },
        "longitude": {
          "type": "number",
          "description": "Longitude coordinate of the charging station."
        },
        "status": {
          "type": "string",
          "description": "Current status of the charging station (e.g., available, in use, offline)."
        },
        "energyConsumption": {
          "type": "number",
          "description": "Current energy consumption of the charging station."
        }
      },
      "required": [
        "id",
        "name",
        "latitude",
        "longitude",
        "status",
        "energyConsumption"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user who can use the charging stations.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "rfid": {
          "type": "string",
          "description": "RFID for user authentication."
        },
        "qrCode": {
          "type": "string",
          "description": "QR code for user authentication."
        }
      },
      "required": [
        "id",
        "rfid",
        "qrCode"
      ]
    },
    "ChargingSession": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ChargingSession",
      "type": "object",
      "description": "Represents a charging session for a user at a charging station.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the charging session."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N ChargingSession)"
        },
        "stationId": {
          "type": "string",
          "description": "Reference to ChargingStation. (Relationship: ChargingStation 1:N ChargingSession)"
        },
        "startTime": {
          "type": "string",
          "description": "Start time of the charging session.",
          "format": "date-time"
        },
        "endTime": {
          "type": "string",
          "description": "End time of the charging session.",
          "format": "date-time"
        },
        "energyConsumed": {
          "type": "number",
          "description": "Energy consumed during the charging session."
        }
      },
      "required": [
        "id",
        "userId",
        "stationId",
        "startTime",
        "endTime",
        "energyConsumed"
      ]
    },
    "Recommendation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Recommendation",
      "type": "object",
      "description": "Represents a smart charge recommendation generated by the AI tool.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the recommendation."
        },
        "stationId": {
          "type": "string",
          "description": "Reference to ChargingStation. (Relationship: ChargingStation 1:N Recommendation)"
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the recommendation was generated.",
          "format": "date-time"
        },
        "recommendedStartTime": {
          "type": "string",
          "description": "Recommended start time for charging.",
          "format": "date-time"
        },
        "predictedGridIssue": {
          "type": "string",
          "description": "Predicted grid issue if the recommendation is not followed."
        }
      },
      "required": [
        "id",
        "stationId",
        "timestamp",
        "recommendedStartTime",
        "predictedGridIssue"
      ]
    },
    "EnergyData": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "EnergyData",
      "type": "object",
      "description": "Represents energy generation, battery status, and environmental impact data.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the energy data record."
        },
        "stationId": {
          "type": "string",
          "description": "Reference to ChargingStation. (Relationship: ChargingStation 1:N EnergyData)"
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the energy data was recorded.",
          "format": "date-time"
        },
        "energyGenerated": {
          "type": "number",
          "description": "Energy generated by the charging station."
        },
        "batteryStatus": {
          "type": "number",
          "description": "Current battery status of the charging station."
        },
        "estimatedEnvironmentalImpact": {
          "type": "string",
          "description": "Estimated environmental impact of the charging station's usage."
        }
      },
      "required": [
        "id",
        "stationId",
        "timestamp",
        "energyGenerated",
        "batteryStatus",
        "estimatedEnvironmentalImpact"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user data. Path-based ownership ensures only the authenticated user can access their own data.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/chargingStations/{stationId}",
        "definition": {
          "entityName": "ChargingStation",
          "schema": {
            "$ref": "#/backend/entities/ChargingStation"
          },
          "description": "Stores charging station data. Globally readable for real-time monitoring. Write access restricted to admins.",
          "params": [
            {
              "name": "stationId",
              "description": "The unique identifier of the charging station."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/chargingSessions/{sessionId}",
        "definition": {
          "entityName": "ChargingSession",
          "schema": {
            "$ref": "#/backend/entities/ChargingSession"
          },
          "description": "Stores charging session data for each user. Path-based ownership allows users to manage their own history.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "sessionId",
              "description": "The unique identifier of the charging session."
            }
          ]
        }
      },
      {
        "path": "/chargingStations/{stationId}/recommendations/{recommendationId}",
        "definition": {
          "entityName": "Recommendation",
          "schema": {
            "$ref": "#/backend/entities/Recommendation"
          },
          "description": "Stores smart charge recommendations for each charging station. Write access restricted to the AI tool.",
          "params": [
            {
              "name": "stationId",
              "description": "The unique identifier of the charging station."
            },
            {
              "name": "recommendationId",
              "description": "The unique identifier of the recommendation."
            }
          ]
        }
      },
      {
        "path": "/chargingStations/{stationId}/energyData/{energyDataId}",
        "definition": {
          "entityName": "EnergyData",
          "schema": {
            "$ref": "#/backend/entities/EnergyData"
          },
          "description": "Stores energy data for each charging station. Write access restricted to the charging stations or a dedicated data ingestion service.",
          "params": [
            {
              "name": "stationId",
              "description": "The unique identifier of the charging station."
            },
            {
              "name": "energyDataId",
              "description": "The unique identifier of the energy data record."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the SolarCharge application's features, focusing on real-time monitoring, user authentication, charging session management, smart charge recommendations, energy analytics, and station location services. The structure prioritizes authorization independence by using path-based ownership for user-specific data and segregates data based on access needs. This design avoids `get()` calls in security rules, enabling atomic operations and easier debugging.\n\n1.  **Users Collection:** The `/users/{userId}` collection stores user data.  Path-based ownership is used, simplifying security rules where only the authenticated user can access their own data. The User documents contains fields like `rfid` and `qrCode` to be used for identification.\n2.  **Charging Stations Collection:** The `/chargingStations/{stationId}` collection stores information about each charging station.  This collection is globally accessible for reading, enabling the real-time station monitoring feature. Write access is likely restricted to authorized admins (not modeled here, but easily done with a separate `/roles_admin/{uid}` collection and existence check in rules).\n3.  **Charging Sessions Subcollection:** The `/users/{userId}/chargingSessions/{sessionId}` subcollection stores charging session data for each user. This structure enforces path-based ownership, allowing users to manage their own charging session history.  The subcollection also benefits from implicit indexing on the parent `userId`, making queries efficient.\n4.  **Recommendations Subcollection:** The `/chargingStations/{stationId}/recommendations/{recommendationId}` subcollection stores smart charge recommendations for each charging station.  This structure allows for efficient retrieval of recommendations based on the station.  Security rules would likely restrict write access to the AI tool or authorized personnel.\n5.  **Energy Data Subcollection:** The `/chargingStations/{stationId}/energyData/{energyDataId}` subcollection stores energy data for each charging station.  This structure enables efficient retrieval of energy analytics data for each station.  Security rules would likely restrict write access to the charging stations themselves or a dedicated data ingestion service.\n\nThis structure supports the required QAPs:\n\n*   **Secure Lists:**  The segregation of user data into `/users/{userId}` ensures that listing users doesn't expose private data. List operations on `/chargingStations` are safe because they are intended to be public or restricted to admins.\n*   **Authorization Independence:**  By avoiding `get()` calls in security rules and relying on path-based ownership, the structure ensures that authorization checks are atomic and efficient."
  }
}