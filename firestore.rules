/**
 * @file Firestore Security Rules for SolarCharge Application
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for personal data,
 *                  while allowing public read access to charging station information. Write
 *                  access is restricted based on the data's purpose and origin (e.g., AI tool,
 *                  charging station itself).  The rules avoid expensive `get()` calls by
 *                  relying on path-based authorization and denormalized data where needed.
 *
 * @data_structure
 *  - /users/{userId}: User profiles, accessible only by the user themselves.
 *  - /chargingStations/{stationId}: Public information about charging stations.
 *  - /users/{userId}/chargingSessions/{sessionId}: Charging sessions owned by a specific user.
 *  - /chargingStations/{stationId}/recommendations/{recommendationId}: Recommendations generated by an AI tool for a station.
 *  - /chargingStations/{stationId}/energyData/{energyDataId}: Energy data reported by a charging station.
 *
 * @key_security_decisions
 *  - No user listing is allowed to protect privacy.
 *  - Charging station data is publicly readable.
 *  - The rules explicitly deny any write operation that is not explicitly allowed.
 *  - The rules are designed to support the use of `list` operations.
 *
 * @denormalization_for_authorization
 *  - None necessary at this time given the existing data structure.
 *
 * @structural_segregation
 *  - User-specific data is stored in private subcollections under `/users/{userId}`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows access to user profile data only to the authenticated user.
     * @path /users/{userId}
     * @allow (create) User with ID 'user_abc' can create their own profile.
     *        request.auth.uid == 'user_abc'
     * @allow (get) User with ID 'user_abc' can read their own profile.
     *        request.auth.uid == 'user_abc'
     * @deny (create) User with ID 'user_def' cannot create profile for 'user_abc'.
     *       request.auth.uid == 'user_def', resource.data.id == 'user_abc'
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing all users is forbidden.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to charging station data, but restricts writes.
     * @path /chargingStations/{stationId}
     * @allow (get) Any user can read charging station data.
     *        true
     * @deny (create) Non-admin user cannot create charging station data.
     *        request.auth != null
     * @principle Allows public reads, restricts writes to authorized sources.
     */
    match /chargingStations/{stationId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin role check for writes.
    }

    /**
     * @description Allows a user to manage their own charging session history.
     * @path /users/{userId}/chargingSessions/{sessionId}
     * @allow (create) User with ID 'user_abc' can create a charging session under their ID.
     *        request.auth.uid == 'user_abc'
     * @allow (get) User with ID 'user_abc' can read a charging session under their ID.
     *        request.auth.uid == 'user_abc'
     * @deny (update) User with ID 'user_def' cannot update a charging session under user_abc
     *       request.auth.uid == 'user_def', resource.data.userId == 'user_abc'
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/chargingSessions/{sessionId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Restricts write access to smart charge recommendations to the AI tool.
     * @path /chargingStations/{stationId}/recommendations/{recommendationId}
     * @allow (get) Any user can read recommendation data.
     *        true
     * @deny (create) Non-AI tool cannot create recommendation data.
     *        request.auth != null
     * @principle Restricts writes to authorized sources (AI tool).
     */
    match /chargingStations/{stationId}/recommendations/{recommendationId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add AI tool authentication check for writes.
    }

    /**
     * @description Restricts write access to energy data to the charging stations or a dedicated data ingestion service.
     * @path /chargingStations/{stationId}/energyData/{energyDataId}
     * @allow (get) Any user can read energy data.
     *        true
     * @deny (create) Non-charging station or data ingestion service cannot create energy data.
     *        request.auth != null
     * @principle Restricts writes to authorized sources (charging stations or data ingestion service).
     */
    match /chargingStations/{stationId}/energyData/{energyDataId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add charging station or data ingestion service authentication check for writes.
    }
  }
}